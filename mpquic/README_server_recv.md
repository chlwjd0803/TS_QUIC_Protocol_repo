# Server Receiver (`server_recv.c`) 파라미터 가이드

이 문서는 `server_recv.c` 소스 코드를 이해하기 쉽도록 **주요 함수와 매개변수(인자)** 역할을 정리한 가이드입니다. 

---

## 1. 프로그램 실행 옵션 (Main Arguments)
터미널에서 프로그램을 실행할 때 넣는 옵션들입니다. (`main` 함수 로직)

| 옵션 | 예시 값 | 설명 (역할) |
|---|---|---|
| `--port` | `4433` | 서버가 열어둘 **UDP 포트 번호** |
| `--cert` | `cert.pem` | **TLS 인증서** 파일 경로 (보안 연결용) |
| `--key` | `key.pem` | **TLS 비밀키** 파일 경로 |
| `--out` | `frames_out` | 수신된 데이터를 저장할 **폴더 이름** |
| `--max-frames` | `1000` | 수신할 **최대 프레임 수** (이 숫자만큼 받으면 종료, 0은 무제한) |

---

## 2. 데이터 처리 핵심 함수
네트워크에서 조각나서 들어온 데이터를 다시 합치는 함수들입니다.

### feed_bytes
**기능:** 조각난 데이터를 받아 조립 작업대(s)에 붙여넣고, 완성되면 저장합니다.

> int feed_bytes(rx_stream_ctx_t* s, app_ctx_t* app, const uint8_t* buf, size_t len)

| 매개변수 | 설명 |
|---|---|
| **s** | **[작업대]** 현재 스트림의 조립 상태(받은 길이, 남은 길이 등)를 저장하는 객체 |
| **app** | **[전역 설정]** 프로그램 전체 설정 및 통계(총 수신량 등) 관리자 |
| **buf** | **[데이터]** 방금 네트워크에서 도착한 데이터 조각의 시작 주소 |
| **len** | **[길이]** 방금 도착한 데이터의 바이트 크기 |

### varint_decode
**기능:** 데이터 앞머리에 붙은 "길이 정보(숫자)"를 해석합니다.

> int varint_decode(const uint8_t* b, size_t blen, uint64_t* val, size_t* used)

| 매개변수 | 설명 |
|---|---|
| **b** | **[버퍼]** 숫자가 들어있는 데이터 시작 위치 |
| **blen** | **[남은 크기]** 버퍼에 남아있는 바이트 수 (읽어도 되는지 확인용) |
| **val** | **[결과통]** 해석된 숫자를 담아서 돌려줄 변수의 주소 (Output) |
| **used** | **[사용량]** 숫자를 읽는 데 몇 바이트(1~8)를 썼는지 기록 (Output) |

---

## 3. 통신 콜백 함수 (Callback)
Picoquic 라이브러리가 특정 상황(연결, 데이터 수신 등)에 자동으로 호출하는 함수입니다.

### stream_cb
**기능:** 데이터가 들어오거나 연결이 끊기면 호출됩니다. 가장 중요한 함수입니다.

> int stream_cb(picoquic_cnx_t* cnx, uint64_t sid, uint8_t* bytes, size_t len, picoquic_call_back_event_t ev, void* cb_ctx, void* v_stream_ctx)

| 매개변수 | 설명 |
|---|---|
| **cnx** | **[연결 정보]** 현재 클라이언트와의 연결 상태를 담은 객체 |
| **sid** | **[채널 번호]** 데이터가 들어온 스트림(Stream) ID |
| **bytes** | **[데이터]** 실제 수신된 데이터 내용 (이벤트가 '수신'일 때만 유효) |
| **len** | **[길이]** 수신된 데이터의 길이 |
| **ev** | **[이벤트 종류]** 무슨 일이 일어났는지 (데이터 도착? 연결 종료? 등) |
| **cb_ctx** | **[전역 설정]** main에서 등록해둔 app 구조체 (설정값 참조용) |
| **v_stream_ctx** | (사용 안 함) 스트림별 문맥 포인터 |

### loop_cb
**기능:** 서버가 돌아가는 동안 주기적으로 상태를 체크하거나 로그를 찍습니다.

> int loop_cb(picoquic_quic_t* quic, picoquic_packet_loop_cb_enum cb_mode, void* cb_ctx, void* callback_return)

| 매개변수 | 설명 |
|---|---|
| **quic** | **[QUIC 엔진]** Picoquic 라이브러리 전체 관리 객체 |
| **cb_mode** | **[호출 시점]** 루프의 어느 시점인지 (수신 직후? 준비 완료? 등) |
| **cb_ctx** | **[전역 설정]** main에서 등록한 app 구조체 |

---

## 4. 파일 저장 관련 함수 (Thread)
네트워크 속도 저하를 막기 위해 별도 스레드에서 파일을 저장합니다.

### writer_thread
**기능:** 큐(대기열)에 쌓인 데이터를 하나씩 꺼내서 디스크에 씁니다.

> void* writer_thread(void* arg)

| 매개변수 | 설명 |
|---|---|
| **arg** | **[설정값]** 파일 저장 경로와 파일 디스크립터 정보를 담은 구조체(seg_writer_t) |

### save_bytes_as_file
**기능:** (큐를 안 쓸 때) 데이터를 즉시 .jpg 같은 파일로 저장합니다.

> int save_bytes_as_file(const char* dir, uint64_t idx, const uint8_t* data, size_t len)

| 매개변수 | 설명 |
|---|---|
| **dir** | **[폴더]** 파일을 저장할 디렉토리 경로 |
| **idx** | **[번호]** 파일 이름에 붙을 번호 (예: frame_001.jpg) |
| **data** | **[내용]** 파일에 기록할 데이터 내용 |
| **len** | **[크기]** 기록할 데이터 크기 |

---

## 5. 주요 구조체 상세 (Data Structures)
함수 매개변수로 자주 전달되는 구조체(`struct`)들의 내부 멤버 변수 설명입니다.

### app_ctx_t (전역 설정 관리자)
프로그램 전체에서 공유되는 설정과 통계 정보입니다. `app`이라는 이름으로 자주 전달됩니다.

| 멤버 변수 | 설명 |
|---|---|
| **out_dir** | 프레임을 저장할 **디렉토리 경로** (문자열) |
| **max_frames** | 수신 제한 **프레임 개수** (설정값) |
| **frame_count** | 현재까지 수신 완료한 **프레임 수** (카운터) |
| **bytes_rx_total** | 현재까지 수신한 **총 바이트 수** (통계용) |
| **bytes_saved_total** | 파일로 저장이 완료된 **총 바이트 수** |
| **frame_idx** | 저장할 파일의 번호를 매기기 위한 **인덱스** |

### rx_stream_ctx_t (스트림 작업대)
각 데이터 스트림(채널)마다 하나씩 생성되어, 조각난 데이터를 조립하는 공간입니다. `s`라는 이름으로 사용됩니다.

| 멤버 변수 | 설명 |
|---|---|
| **hbuf[8]** | 데이터의 **헤더(길이 정보 등)**를 임시 저장하는 버퍼 |
| **hgot** | 헤더를 **몇 바이트나 읽었는지** 기록 |
| **hdone** | 헤더 해석이 **완료되었는지** 여부 (0: 미완료, 1: 완료) |
| **plen** | 해석된 **데이터 본문(Payload)의 전체 길이** |
| **pgot** | 현재까지 **얼마나 받았는지** (진행률) |
| **payload** | 실제 데이터가 쌓이는 **동적 메모리 공간** (포인터) |