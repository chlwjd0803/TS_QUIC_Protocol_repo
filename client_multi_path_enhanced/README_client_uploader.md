# Multipath QUIC Client Uploader (Wi-Fi + Hotspot)

이 프로그램은 **Picoquic** 라이브러리를 기반으로 **Wi-Fi**와 **셀룰러(LTE/5G)** 두 가지 경로를 동시에 활용하여 카메라 영상을 서버로 전송합니다.
네트워크 상태(RTT, 패킷 손실)를 실시간으로 분석하여, Wi-Fi 품질이 저하되면 즉시 셀룰러로 경로를 전환(Handover)합니다.

---

## ⚠️ [필독] 실행 전 필수 제약 사항 (Critical Constraints)

이 프로그램은 멀티패스 스위칭 로직이 하드웨어 및 네트워크 구성에 민감하게 반응합니다. **안정적인 동작을 위해 아래 4가지 조건을 반드시 준수해야 합니다.**

### 1. 서버의 네트워크 위치 (Server Location)
* **조건:** 수신 서버는 **반드시 외부망(Public Network)** 에 위치하거나, 두 클라이언트 인터페이스(Wi-Fi, 셀룰러) 모두에서 접근 가능한 **제3의 네트워크**여야 합니다.
* **이유:**
  * 만약 서버가 클라이언트의 Wi-Fi와 동일한 로컬 네트워크(예: 192.168.0.x)에 있다면, 클라이언트가 셀룰러로 전환했을 때 셀룰러 망을 통해 내부 사설 IP인 서버에 접근할 수 없습니다.
  * 따라서 서버는 고정 공인 IP를 가지거나, 클라우드 환경(AWS, GCP 등)에 있어야 합니다.

### 2. 네트워크 인터페이스 분리 (Interface Isolation)
* **조건:** Wi-Fi와 셀룰러는 서버와 서로 다른 서브넷(Subnet)과 게이트웨이를 가져야 합니다.
* **구성 예시:**
  * **Wi-Fi Interface (wlan0):** 192.168.0.x (내부 공유기)
  * **Hotspot Interface (eth1 or usb0):** 192.168.0.x 혹은 172.20.10.x (스마트폰 테더링)
  * **Server :** 165.229.x.x
* **주의:** 두 인터페이스중 하나라도 서버와 동일한 대역에 위치하면 서버는 동일한 대역에 있는 ip만 선택하여 라우팅하는 문제가 발생합니다.

### 3. Wi-Fi 차단 테스트 방법 (Soft Toggle Only)
* **조건:** 테스트 시 Wi-Fi를 끊을 때 **절대로 `sudo nmcli radio wifi off` 명령어를 사용하지 마십시오.**
* **권장 방법:**
  1. **Ubuntu GUI 상단 바**에서 Wi-Fi 토글 스위치 끄기 (권장)
  2. 공유기 전원 끄기 (물리적 차단)
  3. 스마트폰 셀룰러의 경우 데이터 차단
* **이유:** `nmcli`로 인터페이스를 강제로 내리면 리눅스 커널 레벨에서 장치 파일 자체가 사라집니다. 이 경우 프로그램이 소켓에 접근하려는 순간 `Segmentation Fault`가 발생하여 즉시 종료됩니다. GUI 끄기는 인터페이스를 "비활성" 상태로만 만들기 때문에 프로그램이 이를 "경로 실패(Grade 2)"로 정상 인식하고 셀룰러로 안전하게 넘어갑니다. 또는 실제 환경에서는 그냥 와이파이가 멀어져 자연스럽게 연결 해제되도록 두시면 되겠습니다.

### 4. 메트릭 알고리즘 설정 (Metric Tuning)
* **파일:** `path_algo.h`
* **설정:** 현재 코드는 "Wi-Fi가 끊겨도 즉시 죽이지 않고 5초간 유예(Grade 1)"하도록 설정되어 있습니다.
* **주의:** 이 로직을 수정하여 타임아웃을 너무 짧게(예: 1초 미만) 잡으면, 일시적인 패킷 지연이나 재연결 과정에서 경로 등급이 1과 2를 오가는 널뛰기(Flapping) 현상이 발생하거나 프로그램이 종료될 수 있습니다.

---

## 🚀 빌드 및 실행 방법

### 1. 빌드 (Build)
OpenCV와 Picoquic 라이브러리가 링크되어야 합니다. (제공된 CMakeLists.txt 또는 Makefile 사용 권장)

> mkdir build
> cd build
> cmake ..
> make

### 2. 실행 (Usage)
프로그램 실행 시 **4개의 인자**를 순서대로 정확히 입력해야 합니다.

**명령어 형식:**
> ./client_uploader [SERVER_IP] [HOTSPOT_IP] [SERVER_PORT] [WIFI_IP]

* `SERVER_IP`: 데이터를 수신할 서버의 IP 주소 (외부망 권고)
* `HOTSPOT_IP`: 클라이언트의 테더링/셀룰러 인터페이스 로컬 IP (예: 172.20.10.2)
* `SERVER_PORT`: 서버 포트 (기본 4433)
* `WIFI_IP`: 클라이언트의 Wi-Fi 인터페이스 로컬 IP (예: 192.168.0.50)

**실행 예시:**
> ./client_uploader 203.0.113.5 172.20.10.4 4433 192.168.0.170

---

## 📊 경로 선택 알고리즘 동작 원리 (path_algo.h)

이 프로그램은 `fsm_pick` 함수를 통해 패킷을 보낼 경로를 결정합니다.

**등급(Grade) 정의:**
* **0 (GOOD - 매우 좋음):** RTT < 300ms이고 최근 패킷 수신됨. (최우선 선택)
* **1 (WARN - 불안정):** 300ms < RTT < 2000ms 또는 5초 이내에 연결이 끊김. (이 상태가 되면 Hotspot이 Grade 0일 경우 즉시 전환)
* **2 (BAD - 사용 불가):** RTT > 2000ms 또는 5초 이상 응답 없음. (선택 대상 제외)

**동작 시나리오:**
1. **평상시:** Wi-Fi가 **Grade 0**이면 무조건 Wi-Fi를 사용합니다.
2. **장애 발생:** Wi-Fi를 끄거나 신호가 약해져 **Grade 1**이 되는 순간, 대기 중이던 셀룰러(**Grade 0**)이 감지되면 즉시 셀룰러으로 전송을 시작합니다.
3. **복구:** Wi-Fi가 다시 연결되어 **Grade 0**으로 회복되면, 자동으로 Wi-Fi로 복귀합니다.

---

## 🛠 문제 해결 (Troubleshooting)

**Q. 와이파이를 껐는데 프로그램이 Segmentation fault로 꺼집니다.**
* **A.** `nmcli` 명령어를 사용했는지 확인하십시오. 우분투 GUI 메뉴를 통해 와이파이를 꺼야 합니다.

**Q. 셀룰러로 전환되지 않고 전송이 멈춥니다.**
* **A.** 서버 IP가 클라이언트 Wi-Fi와 같은 내부망 대역인지 확인하십시오. 셀룰러 망에서는 내부망(192.168.x.x)에 있는 서버로 접속할 수 없습니다. 반드시 외부망 서버를 사용해야 합니다.

**Q. [DIAG] Wi-Fi Path missing 로그가 계속 뜨고 연결이 안 됩니다.**
* **A.** 입력한 `WIFI_IP` 인자가 실제 `ifconfig` 상의 IP와 일치하는지 확인하십시오. DHCP로 인해 IP가 바뀌었다면 실행 인자를 수정해야 합니다.